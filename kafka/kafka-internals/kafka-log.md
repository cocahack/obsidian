# 로그(로그 세그먼트)

카프카의 토픽으로 들어오는 메시지는 세그먼트(또는 로그 세그먼트)라는 파일에 저장된다. 메시지는 정해진 형식에 맞춰 순차적으로 로그 세그먼트 파일에 저장된다. 로그 세그먼트에는 메시지 내용과 메시지 키, 값, 오프셋, 메시지 크기 등의 정보가 포함되며, 이 파일들은 브로커의 로컬 디스크에 저장된다.

## 로그 파일의 관리

로그 세그먼트가 너무 커져버리면 관리가 어렵기 떄문에 기본적으로 1GB의 크기를 가진다. 

로그 세그먼트가 1GB보다 커지면 롤링(rolling) 전략을 사용하게 된다. 이전의 파일은 닫고 새로운 로그 세그먼트를 생성하는 방식이다.

로그 세그먼트가 계속 늘어날 경우를 대비해 관리 계획도 마련해두어야 한다. 관리하는 방법은 로그 세그먼트 삭제와 컴팩션으로 나뉜다.

### 관리 방법 1. 로그 세그먼트 삭제

server.properties 에서 `log.cleanup.policy`가 `delete` 일 때 로그 세그먼트 삭제를 사용하게 된다.

#### 예시

카프카 설정에 `retension.ms` 값을 주면 로그 세그먼트 보관 기간이 이 값 보다 클 때 세그먼트를 삭제하게 된다. 별도의 옵션을 설정하지 않으면 기본 값은 7일이다. 

이 설정 값을 0으로 준다면, 메시지는 바로 삭제 대상이 될 것이다. 그러나 카프카는 기본적으로 5분 주기(변경 가능)로 로그 세그먼트 파일을 확인하고 삭제하는 작업을 수행한다. 따라서 5분이 지나면 로그는 삭제되어 있을 것이다.

### 관리 방법 2. 컴팩션

로그를 삭제하지 않고 컴팩션하여 보관하는 방법이다. 기본적으로 로컬 디스크에 저장되어 있는 세그먼트들이 대상이며, 현재 활성화된 세그먼트를 제외한 나머지 세그먼트들이 컴팩션 대상이다.

컴팩션은 메시지의 키 값을 기준으로 이뤄지며, 컴팩션 이후에는 그 키의 가장 마지막 데이터만 남아있게 된다. ([[ss-table-and-lsm-tree|SS테이블과 LSM 트리]] 참조)

당연하지만, 이 방식은 메시지 키 값 기준으로 항상 마지막 값이 필요한 경우에만 사용해야 한다. 

#### 장점

장애 복구 시 전체 로그를 복구하지 않고, 메시지의 키를 기준으로 최신 상태만 복구하면 되기 떄문에 빠른 장애 복구가 장점이다. 

#### 단점

메시지에 항상 키를 사용해야 하며(키는 필수가 아님), 키를 기준으로 마지막 값만 필요한 워크로드에 사용해야 한다.