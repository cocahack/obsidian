# 컨트롤러

컨트롤러는 파티션 리더를 선출하는 역할을 하는 브로커이다. 카프카 클러스터에 속한 브로커중 하나가 컨트롤러 역할을 하는 것이다.

컨트롤러는 브로커에 장애가 발생하는지 지속적으로 모니터링한다. 브로커에 장애가 발생하면 즉시 주키퍼에 저장되어 있는 ISR 리스트를 확인해 팔로워 중 하나를 새로운 파티션 리더로 선출한다. 

새로운 리더가 선출되는 동안은 리더가 존재하지 않기 때문에 모든 읽기 및 쓰기 요청이 실패한다. 클라이언트는 설정된 숫자만큼 재시도를 하긴 하지만, 재시도하는 동안 새로운 리더가 선출되지 않으면 요청이 처리되지 않는 것이다. 그래서 재시도하는 시간 안에 빠르게 새로운 리더를 선출하는 것이 중요하다.

## 새로운 리더가 선출되는 과정 - 파티션 리더 종료

### 리더가 예기치 않게 다운되는 경우

1. 리더로 선출된 브로커가 예기치 않게 종료된다.
2. 주키퍼는 리더와의 연결이 끊어진 후, 해당 파티션의 ISR 리스트에 변경점이 발생했음을 인지한다.
3. 컨트롤러는 주키퍼의 ISR 리스트를 `watch` 하고 있으므로 변경점이 발생했음을 역시 알 수 있다. 이를 통해 새로운 리더를 선출한다.
4. 컨트롤러는 새 리더의 정보를 주키퍼에 기록한다.
5. 이렇게 갱신된 정보는 활성화 상태인 모든 브로커에 전파된다.

### Graceful shutdown 으로 리더를 종료하는 경우

1. 관리자는 리더 브로커를 종료하는 명령어를 실행한다. SIG_TERM 시그널이 브로커에 전달된다.
2. 브로커는 이 사실을 컨트롤러에 알린다.
3. 컨트롤러는 새로운 리더를 선출하고 그 결과를 주키퍼에 기록한다.
4. 컨트롤러는 새로운 리더 정보를 다른 브로커에 전파한다.
5. 컨트롤러는 종료 요청을 보낸 브로커에게 정상 종료한다는 응답을 보낸다.
6. 응답을 받은 브로커는 캐시에 있는 내용을 디스크에 저장하고 종료한다.

### 두 경우의 차이점

Graceful shutdown을 적용하면 예기치 않은 장애에 대비하는 프로세스보다 다운타임이 더 적다. 리더가 종료되기 전에 다음 리더를 미리 선출할 수 있기 때문이다.

## 브로커 종료

브로커 자체가 내려가는 경우, 브로커가 담당하는 파티션은 순차적으로 리더를 선출한다. 첫 번째 파티션의 다운타임은 길지 않지만, 가장 마지막에 리더가 변경되는 파티션은 다운타임이 꽤 길다고 한다.

Graceful shutdown을 사용하는 경우, 브로커는 자신의 모든 로그를 디스크에 동기화한 뒤 종료한다. 따라서 브로커를 재시작할 때 로그 복구 시간이 짧다 (이는 `controlled.shutdown.enable` 값이 `true` 여야 적용된다).

