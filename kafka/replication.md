# Replication

카프카는 고가용성을 위해 리플리케이션을 사용한다. 토픽에 `replication-factor`를 설정하면 그 개수만큼 같은 토픽이 여러 카프카 클러스터에 분산되어 생성된다.

## 리더와 팔로워

카프카는 내부적으로 동일한 리플리케이션을 리더와 팔로워로 구분하며, 리플리케이션 중 하나는 리더가 된다. 모든 읽기와 쓰기 요청은 리더로만 처리하게 된다. 

리더에 문제가 발생하면 팔로워 중 하나가 리더가 되어 요청을 처리하게 된다. 따라서 팔로워는 리더가 새로운 메시지를 받았는지 확인하고, 있다면 메시지를 리더로부터 복제해오는 작업을 계속 수행한다.

### 복제 유지와 커밋

리더와 팔로워는 ISR(In Sync Replica)라는 논리적인 그룹에 묶여 있다. 리더는 이 그룹 내에서만 선정된다. 

ISR 내 모든 팔로워는 리더가 가진 데이터와 자신이 가진 데이터를 일치시키기 위해 지속적으로 리더의 데이터를 따라가게 되고, 리더는 ISR 내 모든 팔로워가 메시지를 받을 때까지 기다린다. 

리더를 따라잡지 못한 팔로워가 있고, 예상치 못한 상황에 리더를 교체해야 할 때 이 팔로워가 리더로 선정되면 이전 메시지가 분실되는 문제가 발생할 수 있다. 그래서 **팔로워가 ISR에 속하려면 리더와 데이터가 일치해야 한다**는 조건이 있다. 

팔로워가 잘 따라오고 있는지는 리더가 판단한다. 팔로워가 특정 시간 안에 복제 요청을 하지 않으면 그 팔로워의 복제 동작에 문제가 있다고 판단하여 ISR 그룹에서 제외시키는 것이다. 

