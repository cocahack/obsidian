# Multi-Version Concurrency Control(MVCC)

## 개요

MySQL의 REPEATABLE READ, 오라클의 READ COMMITTED 등 여러 데이터베이스의 특정 격리 수준을 구현하기 위해 사용되는 기술.

데이터베이스 객체의 특정 시점에 대한 여러 버전을 유지하여 이전에 읽었던 내용을 다른 트랜잭션이 커밋했어도 다시 읽을 수 있게 해준다.

## Details

트랜잭션이 시작되면 각 트랜잭션은 고유한 ID를 할당받는다. 그리고 트랜잭션이 데이터를 쓸 때마다 그 대상에 쓰기를 실행한 트랜잭션의 ID가 붙게 된다. 할당받은 트랜잭션 번호보다 높은 번호를 가진 레코드는 나중에 실행된 트랜잭션이 수정했다는 뜻이며, 이 레코드는 읽을 수 없다.

### MySQL

MySQL에서는 증가하는 고유한 트랜잭션 ID을 사용한다. 

어떤 트랜잭션이 쓰기를 수행하면 그 레코드에 현재 트랜잭션 ID를 기록한다. 만약 이전 트랜잭션 ID가 할당되어 있었다면 그 레코드는 undo log에 저장하여 반복된 읽기를 보장한다. 당연히 하나의 레코드에는 여러 트랜잭션 ID가 기록된 복제본이 여러 개 존재할 수 있다.

#### 주의할 점

반복된 읽기를 보장하기 위해 하나의 레코드에 대해서도 여러 개의 버전을 유지해야 한다. 특정 버전이 제거되려면 그 버전을 참조하는 트랜잭션이 없어야 가능할 것이다. 그러나 트랜잭션의 모종의 이유로 길어진다면 오래된 버전을 계속 유지할 수 밖에 없다. 
따라서 undo log와 undo log를 저장하는 InnoDB 버퍼풀이 유지하고 있어야 할 데이터가 많아지며, 이는 성능 상의 문제를 유발할 수 있다. **트랜잭션은 짧게 유지**하는 것이 좋다.

## 효과

MVCC로 스냅샷 격리를 구현할 수 있으며, 읽기 전용 트랜잭션은 별도의 락을 획득하지 않아도 언제든지 읽기가 가능하다.

---
#db #isolation 